# ç²’å­ç¢°æ’ç³»ç»Ÿ - WebAssembly + WebGL

ä¸€ä¸ªä½¿ç”¨ AssemblyScript (WebAssembly) å¤„ç†ç‰©ç†è®¡ç®—å’Œ WebGL è¿›è¡Œé«˜æ€§èƒ½æ¸²æŸ“çš„ç²’å­ç¢°æ’æ¼”ç¤ºé¡¹ç›®ã€‚

## âœ¨ ç‰¹æ€§

- ğŸš€ **é«˜æ€§èƒ½ç‰©ç†è®¡ç®—**ï¼šä½¿ç”¨ WebAssembly åœ¨æ¥è¿‘åŸç”Ÿé€Ÿåº¦ä¸‹è®¡ç®—ç²’å­ç‰©ç†
- ğŸ¨ **GPU åŠ é€Ÿæ¸²æŸ“**ï¼šä½¿ç”¨ WebGL åœ¨ GPU ä¸Šæ¸²æŸ“å¤§é‡ç²’å­ï¼ˆ800+ ç²’å­ @ 60 FPSï¼‰
- ğŸ’¥ **çœŸå®ç¢°æ’æ£€æµ‹**ï¼šå®ç°äº†å¼¹æ€§ç¢°æ’å’ŒåŠ¨é‡å®ˆæ’
- ğŸ–±ï¸ **äº¤äº’å¼æ§åˆ¶**ï¼šé¼ æ ‡ç‚¹å‡»æ‹–åŠ¨ä¸ç²’å­äº’åŠ¨
- ğŸ¯ **é›¶æ‹·è´æ•°æ®ä¼ è¾“**ï¼šJavaScript å’Œ WebAssembly å…±äº«å†…å­˜ï¼Œæ— æ€§èƒ½æŸå¤±

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒæŠ€æœ¯æ ˆ

- **AssemblyScript**: TypeScript é£æ ¼çš„ WebAssembly è¯­è¨€
- **WebGL**: ç¡¬ä»¶åŠ é€Ÿçš„å›¾å½¢æ¸²æŸ“ API
- **GLSL**: GPU ç€è‰²å™¨è¯­è¨€
- **Vite**: å¿«é€Ÿçš„å¼€å‘æœåŠ¡å™¨å’Œæ„å»ºå·¥å…·
- **TypeScript**: ç±»å‹å®‰å…¨çš„ JavaScript

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Browser                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  JavaScript (main.ts)                                        â”‚
â”‚  â”œâ”€ åˆå§‹åŒ– WebAssembly æ¨¡å—                                  â”‚
â”‚  â”œâ”€ åˆ›å»º WebGL æ¸²æŸ“å™¨                                        â”‚
â”‚  â”œâ”€ å¤„ç†ç”¨æˆ·è¾“å…¥ï¼ˆé¼ æ ‡äº¤äº’ï¼‰                                  â”‚
â”‚  â””â”€ åŠ¨ç”»å¾ªç¯ï¼ˆrequestAnimationFrameï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WebAssembly (assembly/index.ts)                            â”‚
â”‚  â”œâ”€ ç²’å­æ•°æ®ç®¡ç†ï¼ˆä½ç½®ã€é€Ÿåº¦ã€åŠå¾„ã€è´¨é‡ï¼‰                      â”‚
â”‚  â”œâ”€ ç‰©ç†è®¡ç®—                                                 â”‚
â”‚  â”‚  â”œâ”€ ç¢°æ’æ£€æµ‹ï¼ˆO(nÂ²) æš´åŠ›ç®—æ³•ï¼‰                             â”‚
â”‚  â”‚  â”œâ”€ å¼¹æ€§ç¢°æ’å“åº”ï¼ˆåŠ¨é‡å®ˆæ’ï¼‰                               â”‚
â”‚  â”‚  â”œâ”€ è¾¹ç•Œæ£€æµ‹                                              â”‚
â”‚  â”‚  â””â”€ åŠ›åœºè®¡ç®—ï¼ˆé‡åŠ›ã€é¼ æ ‡æ¨åŠ›ï¼‰                             â”‚
â”‚  â””â”€ é›¶æ‹·è´å†…å­˜å…±äº«                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  WebGL æ¸²æŸ“ç®¡çº¿                                              â”‚
â”‚  â”œâ”€ é¡¶ç‚¹ç€è‰²å™¨ (vertexShaderSource.glsl)                    â”‚
â”‚  â”‚  â”œâ”€ åæ ‡ç³»è½¬æ¢ï¼ˆå±å¹•ç©ºé—´ â†’ è£å‰ªç©ºé—´ï¼‰                       â”‚
â”‚  â”‚  â””â”€ æ•°æ®ä¼ é€’ï¼ˆvarying å˜é‡æ’å€¼ï¼‰                           â”‚
â”‚  â”œâ”€ ç‰‡æ®µç€è‰²å™¨ (fragmentShaderSource.glsl)                  â”‚
â”‚  â”‚  â”œâ”€ åœ†å½¢ç»˜åˆ¶ï¼ˆè·ç¦»åœºæŠ€æœ¯ï¼‰                                 â”‚
â”‚  â”‚  â”œâ”€ å¹³æ»‘è¾¹ç¼˜ï¼ˆsmoothstep æŠ—é”¯é½¿ï¼‰                          â”‚
â”‚  â”‚  â””â”€ é¢œè‰²è®¡ç®—                                              â”‚
â”‚  â””â”€ GPU å…‰æ …åŒ– & æ··åˆ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
wasm-webgl/
â”œâ”€â”€ assembly/              # AssemblyScript æºä»£ç 
â”‚   â”œâ”€â”€ index.ts          # ç²’å­ç‰©ç†è®¡ç®—æ ¸å¿ƒé€»è¾‘
â”‚   â””â”€â”€ tsconfig.json     # AssemblyScript ç¼–è¯‘é…ç½®
â”œâ”€â”€ build/                # WebAssembly ç¼–è¯‘è¾“å‡º
â”‚   â”œâ”€â”€ release.wasm      # ä¼˜åŒ–åçš„ WASM æ¨¡å—
â”‚   â”œâ”€â”€ release.d.ts      # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ debug.wasm        # è°ƒè¯•ç‰ˆæœ¬
â”œâ”€â”€ src/                  # JavaScript/TypeScript æºä»£ç 
â”‚   â”œâ”€â”€ main.ts           # ä¸»ç¨‹åºå…¥å£ + WebGL æ¸²æŸ“å™¨
â”‚   â”œâ”€â”€ vertexShaderSource.glsl    # é¡¶ç‚¹ç€è‰²å™¨
â”‚   â””â”€â”€ fragmentShaderSource.glsl  # ç‰‡æ®µç€è‰²å™¨
â”œâ”€â”€ index.html            # HTML å…¥å£
â”œâ”€â”€ package.json          # é¡¹ç›®ä¾èµ–å’Œè„šæœ¬
â”œâ”€â”€ tsconfig.json         # TypeScript é…ç½®
â”œâ”€â”€ asconfig.json         # AssemblyScript é…ç½®
â””â”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Node.js >= 16
- pnpm (æ¨è) æˆ– npm

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### ç¼–è¯‘ WebAssembly

```bash
pnpm asbuild
```

è¿™ä¼šç¼–è¯‘ `assembly/index.ts` å¹¶ç”Ÿæˆï¼š

- `build/debug.wasm` - è°ƒè¯•ç‰ˆæœ¬ï¼ˆåŒ…å«è°ƒè¯•ä¿¡æ¯ï¼‰
- `build/release.wasm` - ç”Ÿäº§ç‰ˆæœ¬ï¼ˆä¼˜åŒ–åï¼‰

### å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
pnpm dev
```

è®¿é—® `http://localhost:5173` æŸ¥çœ‹æ•ˆæœã€‚

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬

```bash
pnpm build
```

## ğŸ® ä½¿ç”¨è¯´æ˜

- **é¼ æ ‡ç§»åŠ¨**ï¼šæŸ¥çœ‹ç²’å­è¿åŠ¨
- **ç‚¹å‡»æ‹–åŠ¨**ï¼šåœ¨é¼ æ ‡ä½ç½®æ–½åŠ æ¨åŠ›ï¼Œæ¨å¼€é™„è¿‘çš„ç²’å­
- **è°ƒæ•´å‚æ•°**ï¼šç¼–è¾‘æºä»£ç ä¸­çš„å¸¸é‡æ¥æ”¹å˜è¡Œä¸º

## ğŸ”§ æ ¸å¿ƒæ¦‚å¿µ

### 1. WebAssembly å†…å­˜ç®¡ç†

```typescript
// JavaScript ä¾§ - é›¶æ‹·è´è®¿é—® WASM å†…å­˜
const particlesPtr = wasm.getParticlesPtr();
const memory = new Float32Array(
  wasm.memory.buffer, // ç›´æ¥å¼•ç”¨ï¼Œä¸æ‹·è´ï¼
  particlesPtr,
  PARTICLE_COUNT * PARTICLE_SIZE
);
```

**å…³é”®ç‚¹**ï¼š

- `wasm.memory.buffer` è¿”å› WebAssembly çº¿æ€§å†…å­˜çš„å¼•ç”¨
- ä½¿ç”¨ `Float32Array` åˆ›å»ºè§†å›¾ï¼Œä¸ä¼šæ‹·è´æ•°æ®
- JavaScript å’Œ WebAssembly å…±äº«åŒä¸€å—å†…å­˜

### 2. ç²’å­æ•°æ®ç»“æ„

æ¯ä¸ªç²’å­å ç”¨ 6 ä¸ª float32ï¼ˆ24 å­—èŠ‚ï¼‰ï¼š

```
[x, y, vx, vy, radius, mass]
 0  1  2   3   4      5     (ç´¢å¼•)
```

- `x, y`: ä½ç½®ï¼ˆåƒç´ ï¼‰
- `vx, vy`: é€Ÿåº¦ï¼ˆåƒç´ /ç§’ï¼‰
- `radius`: åŠå¾„ï¼ˆåƒç´ ï¼‰
- `mass`: è´¨é‡ï¼ˆç”¨äºç¢°æ’è®¡ç®—ï¼‰

### 3. ç¢°æ’æ£€æµ‹ç®—æ³•

```typescript
// ç®€åŒ–çš„ç¢°æ’æ£€æµ‹é€»è¾‘
for (let i = 0; i < particleCount - 1; i++) {
  for (let j = i + 1; j < particleCount; j++) {
    const dx = x2 - x1;
    const dy = y2 - y1;
    const distSq = dx * dx + dy * dy;
    const minDistSq = (r1 + r2) * (r1 + r2);

    if (distSq < minDistSq) {
      // å‘ç”Ÿç¢°æ’ï¼Œè®¡ç®—å“åº”...
    }
  }
}
```

**æ—¶é—´å¤æ‚åº¦**ï¼šO(nÂ²)  
**é€‚ç”¨åœºæ™¯**ï¼šä¸­ç­‰æ•°é‡ç²’å­ï¼ˆ<1000ï¼‰  
**ä¼˜åŒ–æ–¹å‘**ï¼šç©ºé—´åˆ†åŒºï¼ˆç½‘æ ¼ã€å››å‰æ ‘ï¼‰

### 4. WebGL æ¸²æŸ“æµç¨‹

```
CPU æ•°æ®å‡†å¤‡
    â†“
é¡¶ç‚¹æ•°æ®ä¸Šä¼ åˆ° GPU (gl.bufferData)
    â†“
é¡¶ç‚¹ç€è‰²å™¨ (æ¯ä¸ªé¡¶ç‚¹è¿è¡Œä¸€æ¬¡)
    â†“
å…‰æ …åŒ– (GPU è‡ªåŠ¨å¤„ç†)
    â†“
ç‰‡æ®µç€è‰²å™¨ (æ¯ä¸ªåƒç´ è¿è¡Œä¸€æ¬¡)
    â†“
æ··åˆ & è¾“å‡ºåˆ°å±å¹•
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### å·²å®ç°çš„ä¼˜åŒ–

1. **WebAssembly ç‰©ç†è®¡ç®—**ï¼šæ¯”çº¯ JavaScript å¿« 2-5 å€
2. **GPU æ¸²æŸ“**ï¼šå¯åŒæ—¶æ¸²æŸ“æ•°åƒä¸ªç²’å­
3. **é›¶æ‹·è´å†…å­˜è®¿é—®**ï¼šJavaScript ç›´æ¥è¯»å– WASM å†…å­˜
4. **æ‰¹é‡ç»˜åˆ¶**ï¼šä¸€æ¬¡ `drawArrays` è°ƒç”¨ç»˜åˆ¶æ‰€æœ‰ç²’å­
5. **é˜»å°¼ç³»æ•°**ï¼šé˜²æ­¢ç²’å­é€Ÿåº¦æ— é™å¢é•¿

### å¯ä¼˜åŒ–çš„æ–¹å‘

1. **ç©ºé—´åˆ†åŒº**ï¼šä½¿ç”¨ç½‘æ ¼æˆ–å››å‰æ ‘ä¼˜åŒ–ç¢°æ’æ£€æµ‹
   - å½“å‰ï¼šO(nÂ²) â†’ ä¼˜åŒ–åï¼šO(n log n) æˆ– O(n)
2. **å®ä¾‹åŒ–æ¸²æŸ“**ï¼šä½¿ç”¨ `drawArraysInstanced` å‡å°‘ç»˜åˆ¶è°ƒç”¨
3. **Web Workers**ï¼šåœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œç‰©ç†è®¡ç®—
4. **å¯è°ƒæ•´ç²’å­æ•°é‡**ï¼šæ·»åŠ  UI æ§åˆ¶

## ğŸ¨ è‡ªå®šä¹‰

### ä¿®æ”¹ç²’å­å¤–è§‚

ç¼–è¾‘ `src/fragmentShaderSource.glsl`ï¼š

```glsl
// ä¿®æ”¹é¢œè‰²
vec3 baseColor = vec3(1.0, 0.5, 0.3); // æ©™è‰²

// ä¿®æ”¹é€æ˜åº¦
gl_FragColor = vec4(baseColor, alpha * 0.5); // æ›´é€æ˜

// æ·»åŠ æ¸å˜æ•ˆæœ
vec3 color1 = vec3(0.3, 0.7, 1.0); // è“è‰²
vec3 color2 = vec3(1.0, 0.3, 0.5); // ç²‰è‰²
vec3 color = mix(color1, color2, normalizedDist);
```

### ä¿®æ”¹ç‰©ç†å‚æ•°

ç¼–è¾‘ `src/main.ts`ï¼š

```typescript
// ç²’å­æ•°é‡
const PARTICLE_COUNT = 1500;

// é‡åŠ›å¼ºåº¦
wasm.applyGravity(0, 20); // å¢å¤§é‡åŠ›

// é¼ æ ‡æ¨åŠ›
wasm.applyForce(mouseX, mouseY, 200, 300); // æ›´å¤§èŒƒå›´å’ŒåŠ›é‡
```

ç¼–è¾‘ `assembly/index.ts`ï¼š

```typescript
// åˆå§‹é€Ÿåº¦
particles[offset + 2] = <f32>((Math.random() - 0.5) * 100); // æ›´å¿«

// é˜»å°¼ç³»æ•°
const damping: f32 = 0.995; // æ›´å°çš„é˜»å°¼ï¼Œç²’å­è¿åŠ¨æ›´æŒä¹…

// æ¢å¤ç³»æ•°ï¼ˆå¼¹æ€§ï¼‰
const restitution: f32 = 0.95; // æ›´å¼¹æ€§çš„ç¢°æ’
```

## ğŸ“š å­¦ä¹ èµ„æº

### WebAssembly

- [AssemblyScript å®˜æ–¹æ–‡æ¡£](https://www.assemblyscript.org/)
- [WebAssembly MDN](https://developer.mozilla.org/zh-CN/docs/WebAssembly)

### WebGL

- [WebGL åŸºç¡€æ•™ç¨‹](https://webglfundamentals.org/webgl/lessons/zh_cn/)
- [The Book of Shaders](https://thebookofshaders.com/?lan=ch)

### ç‰©ç†æ¨¡æ‹Ÿ

- [2D ç¢°æ’æ£€æµ‹](https://developer.mozilla.org/en-US/docs/Games/Techniques/2D_collision_detection)
- [å¼¹æ€§ç¢°æ’å…¬å¼](https://en.wikipedia.org/wiki/Elastic_collision)

## ğŸ› å¸¸è§é—®é¢˜

### Q: ç¼–è¯‘ AssemblyScript å¤±è´¥ï¼Ÿ

ç¡®ä¿å·²å®‰è£…ä¾èµ–å¹¶è¿è¡Œï¼š

```bash
pnpm install
pnpm asbuild
```

### Q: æ€§èƒ½ä¸ä½³ï¼ŒFPS ä½ï¼Ÿ

1. å‡å°‘ç²’å­æ•°é‡ï¼šä¿®æ”¹ `PARTICLE_COUNT`
2. æ£€æŸ¥æµè§ˆå™¨ç¡¬ä»¶åŠ é€Ÿæ˜¯å¦å¼€å¯
3. ä½¿ç”¨ Release ç‰ˆæœ¬çš„ WASMï¼ˆè‡ªåŠ¨ä½¿ç”¨ï¼‰

### Q: ç²’å­æ¶ˆå¤±æˆ–è¡Œä¸ºå¼‚å¸¸ï¼Ÿ

æ£€æŸ¥ WebAssembly å†…å­˜æ˜¯å¦å¢é•¿å¯¼è‡´ buffer å¼•ç”¨å¤±æ•ˆã€‚å½“å‰ä»£ç æ¯å¸§é‡æ–°è·å–ï¼Œåº”è¯¥æ²¡é—®é¢˜ã€‚

### Q: å¦‚ä½•è°ƒè¯• WebAssembly ä»£ç ï¼Ÿ

1. ä½¿ç”¨ `build/debug.wasm` ç‰ˆæœ¬
2. åœ¨æµè§ˆå™¨å¼€å‘å·¥å…·ä¸­æŸ¥çœ‹ WASM æºç 
3. æ·»åŠ  `console.log` è°ƒè¯•ï¼ˆéœ€è¦é…ç½® importsï¼‰

## ğŸ“ è®¸å¯è¯

MIT License - è‡ªç”±ä½¿ç”¨ã€ä¿®æ”¹å’Œåˆ†å‘

## ğŸ™ è‡´è°¢

- AssemblyScript å›¢é˜Ÿ
- WebGL ç¤¾åŒº
- æ‰€æœ‰å¼€æºè´¡çŒ®è€…

---

**å¼€å§‹æ¢ç´¢é«˜æ€§èƒ½ Web å›¾å½¢ç¼–ç¨‹å§ï¼** ğŸš€
